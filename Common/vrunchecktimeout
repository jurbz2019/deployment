# This file is subject to the terms and conditions defined in
# 'LICENSE.txt', which is part of this source code distribution.
#
# Copyright 2012-2019 Software Assurance Marketplace

TOMCATLOGDIR="/opt/tomcat/logs"
RUNOUT=/mnt/out/run.out
EVENTOUT="/dev/ttyS1"

# allow at most one instance of checktimeout to run
# checktimeout can run indefinitely if it enters
# the checking for connected users loop
if ! mkdir /var/lock/checktimeoutlockdir
then
	exit
fi

# if the web application has been running for at least CHECKTIMEOUT_DURATION seconds
# and there has been no tomcat activity for CHECKTIMEOUT_LASTLOG seconds then shutdown
read runtime lastlog <<< $(/mnt/in/checktimeout.pl $VIEWER $TOMCATLOGDIR $CHECKTIMEOUT_LASTLOG)
if [[ $runtime -gt $CHECKTIMEOUT_DURATION && $lastlog -gt $CHECKTIMEOUT_LASTLOG ]] 
then
	echo "`date +"%Y/%m/%d %H:%M:%S"`: [$$] runtime: $runtime [$CHECKTIMEOUT_DURATION] lastlog: $lastlog [$CHECKTIMEOUT_LASTLOG]" >> $RUNOUT 2>&1

	echo "`date +"%Y/%m/%d %H:%M:%S"`: [$$] Checking for connected users" >> $RUNOUT 2>&1
	echo "CONNECTEDUSERS" > $EVENTOUT
	connected_users="$(who)"
	while [ "$connected_users" != "" ]
	do
		echo "`date +"%Y/%m/%d %H:%M:%S"`: [$$] $connected_users" >> $RUNOUT 2>&1
        echo "$connected_users" > $EVENTOUT
        sleep 30
        connected_users="$(who)"
	done

	echo "`date +"%Y/%m/%d %H:%M:%S"`: [$$] Shutting down $VIEWER viewer vm via checktimeout" >> $RUNOUT 2>&1
	echo "TIMERSHUTDOWN" > $EVENTOUT
 	/sbin/shutdown -h now
fi
rmdir /var/lock/checktimeoutlockdir
